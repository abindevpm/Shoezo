<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Edit Product - SHOEZO</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    body {
      background-color: #f8f9fa;
      padding-top: 60px;
      overflow-x: hidden;
    }

    .sidebar-container {
      width: 250px;
      min-height: 100vh;
      background-color: #ffffff !important;
      position: fixed;
      top: 60px;
      left: 0;
      z-index: 1020;
    }

    .main-content {
      margin-left: 250px;
      padding: 20px;
      width: calc(100% - 250px);
    }

    .card-form-variants {
      border: 1px solid #ddd;
      padding: 20px;
      border-radius: 8px;
      background-color: #fff;
    }

    .upload-box {
      border: 2px dashed #ddd;
      height: 120px;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      text-align: center;
      border-radius: 10px;
    }

    .form-label {
      font-weight: 500;
      margin-bottom: 0;
    }
  </style>
</head>

<body>

  <%- include('../partials/admin/navbar.ejs') %>

  <div class="d-flex w-100">

    <div class="sidebar-container">
      <%- include('../partials/admin/sidebar.ejs') %>
    </div>

    <div class="main-content">

      <div class="d-flex justify-content-between align-items-center mb-4">
        <h4 class="fw-bold">Edit Product</h4>
        <a href="/admin/products" class="btn btn-secondary btn-sm">Back</a>
      </div>

      <div class="card p-4 shadow-sm border-0">

        <!-- EDIT PRODUCT FORM -->
        <form method="POST"
          action="/admin/edit-product/<%= product._id %>"
          enctype="multipart/form-data">

          <!-- PRODUCT NAME -->
          <div class="row mb-3 align-items-center">
            <div class="col-md-2 text-md-end">
              <label class="form-label">Product Name :</label>
            </div>
            <div class="col-md-10">
              <input type="text"
                class="form-control form-control-sm"
                name="name"
                value="<%= product.name %>" required>
            </div>
          </div>

          <!-- CATEGORY + BRAND -->
          <div class="row mb-3 align-items-center">

            <div class="col-md-2 text-md-end">
              <label class="form-label">Category :</label>
            </div>
            <div class="col-md-4">
              <select class="form-select form-select-sm" name="category" required>
                <% categories.forEach(cat => { %>
                  <option value="<%= cat._id %>"
                    <%= product.category && cat._id.toString() === product.category._id.toString() ? "selected" : "" %>>
                    <%= cat.name %>
                  </option>
                <% }) %>
              </select>
            </div>

            <div class="col-md-2 text-md-end">
              <label class="form-label">Brand :</label>
            </div>
            <div class="col-md-4">
              <select class="form-select form-select-sm" name="brand" required>
                <option value="">Select Brand</option>
                <% brands.forEach(brand => { %>
                  <option value="<%= brand._id %>"
                    <%= product.brand &&
                    (product.brand._id ? product.brand._id.toString() : product.brand.toString()) === brand._id.toString()
                      ? "selected" : "" %>>
                    <%= brand.name %>
                  </option>
                <% }) %>
              </select>
            </div>

          </div>

          <!-- DESCRIPTION -->
          <div class="row mb-3 align-items-center">
            <div class="col-md-2 text-md-end">
              <label class="form-label">Description :</label>
            </div>
            <div class="col-md-10">
              <input type="text"
                class="form-control form-control-sm"
                name="description"
                value="<%= product.description %>">
            </div>
          </div>

          <!-- PRICE -->
          <div class="row mb-3 align-items-center">
            <div class="col-md-2 text-md-end">
              <label class="form-label">Price :</label>
            </div>
            <div class="col-md-10">
              <input type="number"
                class="form-control form-control-sm"
                name="price"
                value="<%= product.price %>">
            </div>
          </div>

          <!-- OFFER PRICE -->
          <div class="row mb-3 align-items-center">
            <div class="col-md-2 text-md-end">
              <label class="form-label">Offer Price :</label>
            </div>
            <div class="col-md-10">
              <input type="number"
                class="form-control form-control-sm"
                name="offerPrice"
                value="<%= product.offerPrice %>">
            </div>
          </div>

          <!-- VARIANTS -->
          <h5 class="fw-bold mb-3">Product Variants</h5>

          <div class="card-form-variants mb-4">
            <div class="row g-3">

              <div class="col-md-4">
                <label class="form-label">Size</label>
                <input type="text" class="form-control form-control-sm"
                  name="size" value="<%= product.variants[0].size %>">
              </div>

              <div class="col-md-4">
                <label class="form-label">Color</label>
                <input type="text" class="form-control form-control-sm"
                  name="color" value="<%= product.variants[0].color %>">
              </div>

              <div class="col-md-4">
                <label class="form-label">Stock</label>
                <input type="number" class="form-control form-control-sm"
                  name="stock" value="<%= product.variants[0].stock %>">
              </div>

            </div>
          </div>

          <!-- EXISTING IMAGES -->
          <label class="form-label mb-2">Existing Images</label>
          <div class="d-flex flex-wrap gap-3 mb-3">
            <% product.images.forEach(img => { %>
              <div style="position:relative;width:100px;height:100px;">
                <img src="/uploads/product-images/<%= img %>"
                  style="width:100%;height:100%;object-fit:cover;border-radius:8px;">
                <button type="button"
                  class="btn btn-danger btn-sm delete-image-btn"
                  data-img="<%= img %>"
                  style="position:absolute;top:-6px;right:-6px;border-radius:50%;font-size:12px;">
                  ✕
                </button>
              </div>
            <% }) %>
          </div>

          <!-- UPLOAD -->
          <label class="form-label">Upload New Images</label>
          <div class="upload-box mb-3"
            onclick="document.getElementById('imagesInput').click()">
            <i class="fas fa-upload text-muted me-2"></i> Click to upload
          </div>
          <input type="file" id="imagesInput" name="images" multiple hidden>

          <!-- SUBMIT -->
          <div class="text-center mt-4">
            <button type="submit" class="btn btn-dark px-5">
              UPDATE PRODUCT
            </button>
          </div>

        </form>

      </div>
    </div>
  </div>

</body>
</html>



<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>

// DELETE IMAGE FUNCTION
document.querySelectorAll(".delete-image-btn").forEach(btn => {
    btn.addEventListener("click", async () => {

        const imgName = btn.getAttribute("data-img");
        const productId = "<%= product._id %>";

        const response = await fetch(`/admin/delete-product-image/${productId}/${imgName}`, {
            method: "DELETE"
        });

        const data = await response.json();

        if (data.success) {
            location.reload();

        }
    });
});


// ✅ VALIDATION FUNCTION (Global Scope)
function validateForm() {

    let name = document.querySelector("input[name='name']").value.trim();
    let category = document.querySelector("select[name='category']").value.trim();
    let brand = document.querySelector("input[name='brand']").value.trim();
    let description = document.querySelector("input[name='description']").value.trim();
    let price = document.querySelector("input[name='price']").value.trim();
    let offerPrice = document.querySelector("input[name='offerPrice']").value.trim();
    let size = document.querySelector("input[name='size']").value.trim();
    let color = document.querySelector("input[name='color']").value.trim();
    let stock = document.querySelector("input[name='stock']").value.trim();

    if (!name || !category || !brand || !description || !price || !offerPrice || !size || !color || !stock) {
        Swal.fire({
            icon: "error",
            title: "All Fields Required",
            text: "Please fill all fields before submitting."
        });
        return false;
    }

    return true; // allow submit
}

</script>
