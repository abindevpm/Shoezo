<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Edit Product - SHOEZO</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/cropperjs/dist/cropper.js"></script>

  <style>
    body {
      background-color: #f8f9fa;
      padding-top: 60px;
      overflow-x: hidden;
    }

    .sidebar-container {
      width: 250px;
      min-height: 100vh;
      background-color: #ffffff !important;
      position: fixed;
      top: 60px;
      left: 0;
      z-index: 1020;
    }

    .main-content {
      margin-left: 250px;
      padding: 20px;
      width: calc(100% - 250px);
    }

    .card-form-variants {
      border: 1px solid #ddd;
      padding: 20px;
      border-radius: 8px;
      background-color: #fff;
    }

    .upload-box {
      border: 2px dashed #ddd;
      height: 120px;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      text-align: center;
      border-radius: 10px;
    }

    .form-label {
      font-weight: 500;
      margin-bottom: 0;
    }
  </style>
</head>

<body>

  <%- include('../partials/admin/navbar.ejs') %>

  <div class="d-flex w-100">

    <div class="sidebar-container">
      <%- include('../partials/admin/sidebar.ejs') %>
    </div>

    <div class="main-content">

      <div class="d-flex justify-content-between align-items-center mb-4">
        <h4 class="fw-bold">Edit Product</h4>
        <a href="/admin/products" class="btn btn-secondary btn-sm">Back</a>
      </div>

      <div class="card p-4 shadow-sm border-0">

        <!-- EDIT PRODUCT FORM -->
        <form method="POST"
          action="/admin/edit-product/<%= product._id %>"
          enctype="multipart/form-data"
          onsubmit = "return validateForm()">

          <!-- PRODUCT NAME -->
          <div class="row mb-3 align-items-center">
            <div class="col-md-2 text-md-end">
              <label class="form-label">Product Name :</label>
            </div>
            <div class="col-md-10">
              <input type="text"
                class="form-control form-control-sm"
                name="name"
                value="<%= product.name %>" >
            </div>
          </div>

          <!-- CATEGORY + BRAND -->
          <div class="row mb-3 align-items-center">

            <div class="col-md-2 text-md-end">
              <label class="form-label">Category :</label>
            </div>
            <div class="col-md-4">
              <select class="form-select form-select-sm" name="category" >
                <% categories.forEach(cat => { %>
                  <option value="<%= cat._id %>"
                    <%= product.category && cat._id.toString() === product.category._id.toString() ? "selected" : "" %>>
                    <%= cat.name %>
                  </option>
                <% }) %>
              </select>
            </div>

            <div class="col-md-2 text-md-end">
              <label class="form-label">Brand :</label>
            </div>
            <div class="col-md-4">
              <select class="form-select form-select-sm" name="brand" >
                <option value="">Select Brand</option>
                <% brands.forEach(brand => { %>
                  <option value="<%= brand._id %>"
                    <%= product.brand &&
                    (product.brand._id ? product.brand._id.toString() : product.brand.toString()) === brand._id.toString()
                      ? "selected" : "" %>>
                    <%= brand.name %>
                  </option>
                <% }) %>
              </select>
            </div>

          </div>

          <!-- DESCRIPTION -->
          <div class="row mb-3 align-items-center">
            <div class="col-md-2 text-md-end">
              <label class="form-label">Description :</label>
            </div>
            <div class="col-md-10">
              <input type="text"
                class="form-control form-control-sm"
                name="description"
                value="<%= product.description %>">
            </div>
          </div>

          <!-- PRICE -->
          <div class="row mb-3 align-items-center">
            <div class="col-md-2 text-md-end">
              <label class="form-label">Price :</label>
            </div>
            <div class="col-md-10">
              <input type="number"
                class="form-control form-control-sm"
                name="price"
                value="<%= product.price %>">
            </div>
          </div>

          <!-- OFFER PRICE -->
          <div class="row mb-3 align-items-center">
            <div class="col-md-2 text-md-end">
              <label class="form-label">Offer Price :</label>
            </div>
            <div class="col-md-10">
              <input type="number"
                class="form-control form-control-sm"
                name="offerPrice"
                value="<%= product.offerPrice %>">
            </div>
          </div>

          <!-- VARIANTS -->
          <h5 class="fw-bold mb-3">Product Variants</h5>

          <div class="card-form-variants mb-4">
            <div class="row g-3">

              <div class="col-md-4">
                <label class="form-label">Size</label>
                <input type="text" class="form-control form-control-sm"
                  name="size" value="<%= product.variants[0].size %>">
              </div>

              <div class="col-md-4">
                <label class="form-label">Color</label>
                <input type="text" class="form-control form-control-sm"
                  name="color" value="<%= product.variants[0].color %>">
              </div>

              <div class="col-md-4">
                <label class="form-label">Stock</label>
                <input type="number" class="form-control form-control-sm"
                  name="stock" value="<%= product.variants[0].stock %>">
              </div>

            </div>
          </div>

          <!-- EXISTING IMAGES -->
          <label class="form-label mb-2">Existing Images</label>
          <div class="d-flex flex-wrap gap-3 mb-3">
            <% product.images.forEach(img => { %>
              <div style="position:relative;width:100px;height:100px;">
                <img src="/uploads/product-images/<%= img %>"
                  style="width:100%;height:100%;object-fit:cover;border-radius:8px;">
                <button type="button"
                  class="btn btn-danger btn-sm delete-image-btn"
                  data-img="<%= img %>"
                  style="position:absolute;top:-6px;right:-6px;border-radius:50%;font-size:12px;">
                  âœ•
                </button>
              </div>
            <% }) %>
          </div>






          <!-- UPLOAD -->
          <label class="form-label">Upload New Images</label>
          <div class="upload-box mb-3"
            onclick="document.getElementById('imagesInput').click()">
            <i class="fas fa-upload text-muted me-2"></i> Click to upload
          </div>

                    <!-- IMAGE PREVIEW AREA -->
<div id="previewContainer" class="d-flex gap-3 flex-wrap mb-3"></div>

<!-- CROP MODAL -->
<div class="modal fade" id="cropModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Crop Image</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body text-center">
        <img id="cropImage" style="max-width:100%;">
      </div>
      <div class="modal-footer">
        <button class="btn btn-dark" id="cropBtn">Crop & Add</button>
      </div>
    </div>
  </div>
</div>





          <input type="file" id="imagesInput" multiple hidden>

          <!-- SUBMIT -->
          <div class="text-center mt-4">
            <button type="submit" class="btn btn-dark px-5">
              UPDATE PRODUCT
            </button>
          </div>

        </form>

      </div>
    </div>
  </div>

</body>
</html>



<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>

// DELETE IMAGE FUNCTION
document.querySelectorAll(".delete-image-btn").forEach(btn => {
    btn.addEventListener("click", async () => {

        const imgName = btn.getAttribute("data-img");
        const productId = "<%= product._id %>";

        const response = await fetch(`/admin/delete-product-image/${productId}/${imgName}`, {
            method: "DELETE"
        });

        const data = await response.json();

        if (data.success) {
            location.reload();

        }
    });
});


    // validation 

    function validateForm() {

  let isValid = true;

  
  const name = document.querySelector("input[name='name']").value.trim();
  const category = document.querySelector("select[name='category']").value;
  const brand = document.querySelector("select[name='brand']").value;
  const description = document.querySelector("input[name='description']").value.trim();
  const price = document.querySelector("input[name='price']").value;
  const offerPrice = document.querySelector("input[name='offerPrice']").value;
  const size = document.querySelector("input[name='size']").value.trim();
  const color = document.querySelector("input[name='color']").value.trim();
  const stock = document.querySelector("input[name='stock']").value;

  // clear old errors
  document.querySelectorAll("small.text-danger").forEach(el => el.innerText = "");

  // PRODUCT NAME
  if (name === "") {
    document.getElementById("nameError").innerText = "Product name is required";
    isValid = false;
  }

  // CATEGORY
  if (!category) {
    document.getElementById("categoryError").innerText = "Please select a category";
    isValid = false;
  }

  // BRAND
  if (!brand) {
    document.getElementById("brandError").innerText = "Please select a brand";
    isValid = false;
  }

  // DESCRIPTION
  if (description.length < 10) {
    document.getElementById("descriptionError").innerText =
      "Description must be at least 10 characters";
    isValid = false;
  }

  // PRICE
  if (price === "" || price <= 0) {
    document.getElementById("priceError").innerText =
      "Enter a valid price";
    isValid = false;
  }

  // OFFER PRICE
  if (offerPrice && Number(offerPrice) >= Number(price)) {
    document.getElementById("offerPriceError").innerText =
      "Offer price must be less than price";
    isValid = false;
  }

  // SIZE
  if (size === "") {
    document.getElementById("sizeError").innerText =
      "Size is required";
    isValid = false;
  }

  // COLOR
  if (color === "") {
    document.getElementById("colorError").innerText =
      "Color is required";
    isValid = false;
  }

  // STOCK
  if (stock === "" || stock < 0) {
    document.getElementById("stockError").innerText =
      "Enter valid stock";
    isValid = false;
  }

  return isValid;
}



//  croppping \


let cropper;
let selectedFiles = [];

const input = document.getElementById("imagesInput");
const preview = document.getElementById("previewContainer");
const cropImage = document.getElementById("cropImage");

input.addEventListener("change", (e) => {
  const file = e.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = () => {
    cropImage.src = reader.result;
    const modal = new bootstrap.Modal(document.getElementById("cropModal"));
    modal.show();

    setTimeout(() => {
      cropper = new Cropper(cropImage, {
        aspectRatio: 1,
        viewMode: 2
      });
    }, 200);
  };
  reader.readAsDataURL(file);
});

document.getElementById("cropBtn").addEventListener("click", () => {
  cropper.getCroppedCanvas({
    width: 500,
    height: 500
  }).toBlob(blob => {
    selectedFiles.push(blob);

    const img = document.createElement("img");
    img.src = URL.createObjectURL(blob);
    img.style.width = "100px";
    img.style.height = "100px";
    img.style.objectFit = "cover";
    img.style.borderRadius = "8px";

    preview.appendChild(img);

    cropper.destroy();
    bootstrap.Modal.getInstance(document.getElementById("cropModal")).hide();
  });
});










</script>
