  <!DOCTYPE html>
  <html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Edit Product - SHOEZO</title>

    <!-- Bootstrap -->
      <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" />
      <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

      <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

    <style>
      body { background:#f8f9fa; padding-top:60px; }
      .sidebar-container { width:250px; position:fixed; top:60px; left:0; min-height:100vh; }
      .main-content { margin-left:250px; padding:20px; }
      .upload-box {
        border:2px dashed #ccc;
        height:120px;
        display:flex;
        align-items:center;
        justify-content:center;
        cursor:pointer;
        border-radius:10px;
      }


      #cropImage {
  max-width: 100%;
  height: auto;
}


.existing-thumb {
  width: 110px;
  height: 110px;
  object-fit: contain;
}

/* Sidebar width = 260px */
.admin-content {
  margin-left: 260px;
  padding: 20px;
  min-height: 100vh;
  background: #f8f9fa;
}

/* Card should not overflow */
.card {
  overflow: hidden;
}


      
    
    </style>
  </head>

  <body>

  <%- include('../partials/admin/navbar.ejs') %>

  <div class="d-flex">
    <div class="sidebar-container">
      <%- include('../partials/admin/sidebar.ejs') %>
    </div>

    <div class="main-content">
      <h4 class="fw-bold mb-3">Edit Product</h4>

      <form method="POST"
            action="/admin/edit-product/<%= product._id %>"
            enctype="multipart/form-data"
            onsubmit="return validateForm()">

        <!-- NAME -->
        <div class="mb-3">
          <label>Product Name</label>
          <input type="text" class="form-control" name="name" value="<%= product.name %>">
          <small class="text-danger" id="nameError"></small>
        </div>

        <!-- CATEGORY + BRAND -->

        <div class="row mb-3">
  <div class="col-md-6">
    <label class="form-label">Category</label>
    <select class="form-select" name="category">
      <% categories.forEach(cat => { %>
        <option value="<%= cat._id %>"
          <%= String(product.category) === String(cat._id) ? "selected" : "" %>>
          <%= cat.name %>
        </option>
      <% }) %>
    </select>
    <small class="text-danger" id="categoryError"></small>
  </div>

  <div class="col-md-6">
    <label class="form-label">Brand</label>
    <select class="form-select" name="brand">
      <% brands.forEach(brand => { %>
        <option value="<%= brand._id %>"
          <%= String(product.brand) === String(brand._id) ? "selected" : "" %>>
          <%= brand.name %>
        </option>
      <% }) %>
    </select>
    <small class="text-danger" id="brandError"></small>
  </div>
</div>




        <!-- PRICE -->
        <!-- <div class="row mb-3">
          <div class="col-md-6">
            <label>Price</label>
            <input type="number" class="form-control" name="price" value="<%= product.price %>">
            <small class="text-danger" id="priceError"></small>
          </div> 
          <div class="col-md-6">
            <label>Offer Price</label>
            <input type="number" class="form-control" name="offerPrice" value="<%= product.offerPrice %>">
            <small class="text-danger" id="offerPriceError"></small>

          </div>
        </div> -->



        <!-- DESCRIPTION -->
<div class="mb-3">
  <label>Description</label>
  <textarea class="form-control"
            name="description"
            rows="3"
            placeholder="Enter product description"><%= product.description %></textarea>
            <small class="text-danger" id="descriptionError"></small>
</div>


<h5 class="fw-bold mt-4">Product Variants</h5>

<div class="card p-3 mb-4">

  <% const variants = Array.isArray(product.variants) ? product.variants : []; %>

  <% variants.forEach((v, i) => { %>
    <div class="row g-2 align-items-end mb-3 variant-row">

      <div class="col-md-3">
  <label class="form-label">Size</label>
  <input class="form-control" name="variants[<%= i %>][size]" value="<%= v.size %>">
  <small class="text-danger sizeError"></small>
</div>

<div class="col-md-3">
  <label class="form-label">Price</label>
  <input type="number" class="form-control" name="variants[<%= i %>][price]" value="<%= v.price %>">
  <small class="text-danger priceError"></small>
</div>

<div class="col-md-3">
  <label class="form-label">Offer Price</label>
  <input type="number" class="form-control" name="variants[<%= i %>][offerPrice]" value="<%= v.offerPrice %>">
  <small class="text-danger offerPriceError"></small>
</div>

<div class="col-md-2">
  <label class="form-label">Stock</label>
  <input type="number" class="form-control" name="variants[<%= i %>][stock]" value="<%= v.stock %>">
  <small class="text-danger stockError"></small>
</div>
<small class="text-danger" id="variantCommonError"></small>


      <div class="col-md-1 d-grid">
      <button type="button"
        class="btn btn-danger"
        onclick="removeVariantRow(this)">✕</button>

      </div>

    </div>
  <% }) %>

</div>




        <!-- EXISTING IMAGES -->
        <label class="fw-bold">Existing Images</label>
        <div class="d-flex gap-3 mb-3">
          <% product.images.forEach(img => { %>
            <div style="position:relative">
              <img src="/uploads/product-images/<%= img %>"
     style="
       width:90px;
       height:90px;
       object-fit:contain;
       image-rendering: auto;
     ">



              <button type="button"
                      class="btn btn-danger btn-sm delete-image-btn"
                      data-img="<%= img %>"
                      style="position:absolute;top:-5px;right:-5px">×</button>
            </div>
          <% }) %>
        </div>

        <!-- UPLOAD -->
        <label class="fw-bold">Upload New Images</label>
        <div class="upload-box mb-3" onclick="document.getElementById('imagesInput').click()">
          Click to upload & crop

        

        </div>

          <small class="text-danger" id="imageError"></small>



        <div id="previewContainer" class="d-flex gap-2 mb-3"></div>

        <input type="file" id="imagesInput" name="images" multiple hidden>

        <button class="btn btn-dark px-5">UPDATE PRODUCT</button>
      </form>
    </div>
  </div>



  

  <!-- CROP MODAL -->
  <div id="cropModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:9999;align-items:center;justify-content:center">
    <div style="background:#fff;width:90%;max-width:800px;border-radius:8px">
      <div class="p-3 d-flex justify-content-between">
        <h5>Crop Image</h5>
        <button id="cancelCrop" class="btn-close"></button>
      </div>
      <div class="p-3" style="max-height:70vh; overflow:auto;">
  <img id="cropImage" style="width:100%; max-height:500px; display:block; margin:auto;">
</div>

      <div class="p-3 text-end">
        <button id="applyCrop" class="btn btn-primary">Crop & Save</button>
      </div>
    </div>
  </div>




   <script>
  const existingImageCount = <%= product.images.length %>;
</script>



<script>
  let variants = <%- JSON.stringify(product.variants || []) %>;
</script>



  <script>
  /* ========= IMAGE CROP LOGIC ========= */




  let selectedFiles = [];
  let filesToCrop = [];
  let cropIndex = 0;
  let cropper = null;

  const input = document.getElementById("imagesInput");
  const preview = document.getElementById("previewContainer");
  const cropModal = document.getElementById("cropModal");
  const cropImage = document.getElementById("cropImage");

  /* FILE SELECT */
  input.addEventListener("change", e => {
    filesToCrop = Array.from(e.target.files);
     
    cropIndex = 0;
    startCropping();
  });

  /* START CROPPING */
  function startCropping() {
    if (cropIndex >= filesToCrop.length) {
      syncInput();
      renderPreview();
      return;
    }

    const reader = new FileReader();

    reader.onload = e => {
      cropImage.src = e.target.result;

      if (cropper) cropper.destroy();
      cropper = new Cropper(cropImage, {
  aspectRatio: 1,
  viewMode: 1,
  autoCropArea: 1,
  background: false,
  movable: true,
  zoomable: true,
  scalable: false,
  cropBoxResizable: true,
  dragMode: "move"


   
   
  });

      cropModal.style.display = "flex"; // ✅ OPEN MODAL
    };

    reader.readAsDataURL(filesToCrop[cropIndex]);
  }

  /* APPLY CROP */
  document.getElementById("applyCrop").onclick = () => {
    if (!cropper) return;

    const canvas = cropper.getCroppedCanvas({
    width: 500,
    height: 500,
    imageSmoothingQuality: "high"
  });
    canvas.toBlob(blob => {
      selectedFiles.push(
        new File([blob], `product-${Date.now()}.jpg`, {
          type: "image/jpeg"
        })
      );

      cropModal.style.display = "none";
      cropper.destroy();
      cropper = null;

      cropIndex++;
      startCropping();
    }, "image/jpeg", 0.9);
  };

  /* CANCEL CROP */
  document.getElementById("cancelCrop").onclick = () => {
    cropModal.style.display = "none";
    if (cropper) {
      cropper.destroy();
      cropper = null;
    }
  };

  /* PREVIEW */
  function renderPreview() {
    preview.innerHTML = "";
    selectedFiles.forEach(file => {
      const img = document.createElement("img");
      img.src = URL.createObjectURL(file);
      img.width = 80;
      img.height = 80;
      img.style.objectFit = "cover";
      img.style.borderRadius = "6px";
      img.style.marginRight = "6px";
      preview.appendChild(img);
    });
  }

  /* SYNC FILE INPUT */
  function syncInput() {
    const dt = new DataTransfer();
    selectedFiles.forEach(f => dt.items.add(f));
    input.files = dt.files;
  }

  /* DELETE EXISTING IMAGE */
  document.querySelectorAll(".delete-image-btn").forEach(btn => {
    btn.onclick = async () => {
      await fetch(
        `/admin/delete-product-image/<%= product._id %>/${btn.dataset.img}`,
        { method: "DELETE" }
      );
      location.reload();
    };
  });



   //  validation 

   function validateForm() {

  // Clear old errors
  document.querySelectorAll("small.text-danger")
    .forEach(el => el.innerText = "");

  let isValid = true;

  const name = document.querySelector("input[name='name']").value.trim();
  const category = document.querySelector("select[name='category']").value;
  const brand = document.querySelector("select[name='brand']").value;
  const description = document.querySelector("textarea[name='description']").value.trim();
  const price = document.querySelector("input[name='price']").value;
  const offerPrice = document.querySelector("input[name='offerPrice']").value;

  // NAME
  if (!name) {
    document.getElementById("nameError").innerText = "Product name is required";
    isValid = false;
  }

  // CATEGORY
  if (!category) {
    document.getElementById("categoryError").innerText = "Category is required";
    isValid = false;
  }

  // BRAND
  if (!brand) {
    document.getElementById("brandError").innerText = "Brand is required";
    isValid = false;
  }

  // DESCRIPTION
  if (!description) {
    document.getElementById("descriptionError").innerText = "Description is required";
    isValid = false;
  }

  // PRICE
  if (!price || price <= 0) {
    document.getElementById("priceError").innerText = "Enter a valid price";
    isValid = false;
  }

  // OFFER PRICE
  if (!offerPrice || offerPrice <= 0) {
    document.getElementById("offerPriceError").innerText = "Enter a valid offer price";
    isValid = false;
  } else if (Number(offerPrice) >= Number(price)) {
    document.getElementById("offerPriceError").innerText =
      "Offer price must be less than price";
    isValid = false;
  }

  // VARIANTS VALIDATION
  const variantRows = document.querySelectorAll(".variant-row");

  variantRows.forEach((row, index) => {
    const size = row.querySelector("input[name*='[size]']").value.trim();
    const color = row.querySelector("input[name*='[color]']").value.trim();
    const stock = row.querySelector("input[name*='[stock]']").value;

    if (!size) {
      row.querySelector(".sizeError").innerText = "Size required";
      isValid = false;
    }

    if (!color) {
      row.querySelector(".colorError").innerText = "Color required";
      isValid = false;
    }

    if (stock === "" || stock < 0) {
      row.querySelector(".stockError").innerText = "Stock must be 0 or more";
      isValid = false;
    }
  });




  const totalImages = existingImageCount + selectedFiles.length;

if (totalImages < 3) {
  document.getElementById("imageError").innerText =
    "At least 3 product images are required";
  isValid = false;
} else {
  document.getElementById("imageError").innerText = "";
}


  return isValid;
}





function renderVariants() {
  const container = document.getElementById("variantList");
  container.innerHTML = "";

  variants.forEach((v, i) => {
    container.innerHTML += `
      <div class="border rounded p-2 mb-2">
        <div class="row align-items-center text-center">

          <div class="col-md-2"><b>${v.size}</b></div>
          <div class="col-md-2">₹${v.price}</div>
          <div class="col-md-2">₹${v.offerPrice}</div>
          <div class="col-md-2">${v.stock}</div>

  <button type="button"
        class="btn btn-danger"
        onclick="removeVariantRow(this)">✕</button>

          <!-- hidden inputs for submit -->
          <input type="hidden" name="variants[${i}][size]" value="${v.size}">
          <input type="hidden" name="variants[${i}][price]" value="${v.price}">
          <input type="hidden" name="variants[${i}][offerPrice]" value="${v.offerPrice}">
          <input type="hidden" name="variants[${i}][stock]" value="${v.stock}">
        </div>
      </div>
    `;
  });
}

renderVariants();





function addVariant() {
  const size = vSize.value.trim();
  const price = vPrice.value;
  const offerPrice = vOfferPrice.value;
  const stock = vStock.value;

  if (!size || !price || !offerPrice || stock === "") {
    alert("All fields required");
    return;
  }

  if (Number(offerPrice) >= Number(price)) {
    alert("Offer price must be less than price");
    return;
  }

  variants.push({ size, price, offerPrice, stock });

  vSize.value = vPrice.value = vOfferPrice.value = vStock.value = "";
  renderVariants();
}





function removeVariantRow(btn) {
  const rows = document.querySelectorAll(".variant-row");
  const commonErr = document.getElementById("variantCommonError");

  commonErr.innerText = "";

  if (rows.length <= 1) {
    commonErr.innerText = "At least one variant is required";
    return false;
  }

  btn.closest(".variant-row").remove();
}




function validateForm() {

  let isValid = true;

  // clear all errors
  document.querySelectorAll("small.text-danger")
    .forEach(el => el.innerText = "");

  /* ---------- BASIC DETAILS ---------- */
  const name = document.querySelector("input[name='name']").value.trim();
  const category = document.querySelector("select[name='category']").value;
  const brand = document.querySelector("select[name='brand']").value;
  const description = document.querySelector("textarea[name='description']").value.trim();

  if (!name) {
    document.getElementById("nameError").innerText = "Product name is required";
    isValid = false;
  }

  if (!category) {
    document.getElementById("categoryError").innerText = "Category is required";
    isValid = false;
  }

  if (!brand) {
    document.getElementById("brandError").innerText = "Brand is required";
    isValid = false;
  }

  if (!description || description.length < 10) {
    document.getElementById("descriptionError").innerText =
      "Description must be at least 10 characters";
    isValid = false;
  }

  /* ---------- VARIANTS ---------- */
  const variantRows = document.querySelectorAll(".variant-row");

  if (variantRows.length < 1) {
    document.getElementById("variantCommonError").innerText =
      "At least one variant is required";
    return false;
  }

  variantRows.forEach(row => {

    const size = row.querySelector("input[name*='[size]']");
    const price = row.querySelector("input[name*='[price]']");
    const offerPrice = row.querySelector("input[name*='[offerPrice]']");
    const stock = row.querySelector("input[name*='[stock]']");

    if (!size.value.trim()) {
      row.querySelector(".sizeError").innerText = "Size is required";
      isValid = false;
    }

    if (!price.value || price.value <= 0) {
      row.querySelector(".priceError").innerText = "Enter a valid price";
      isValid = false;
    }

    if (!offerPrice.value || offerPrice.value <= 0) {
      row.querySelector(".offerPriceError").innerText = "Enter a valid offer price";
      isValid = false;
    } else if (Number(offerPrice.value) >= Number(price.value)) {
      row.querySelector(".offerPriceError").innerText =
        "Offer price must be less than price";
      isValid = false;
    }

    if (stock.value === "" || stock.value < 0) {
      row.querySelector(".stockError").innerText = "Stock must be 0 or more";
      isValid = false;
    }
  });

  /* ---------- IMAGES ---------- */
  const totalImages = existingImageCount + selectedFiles.length;

  if (totalImages < 3) {
    document.getElementById("imageError").innerText =
      "Minimum 3 product images required";
    isValid = false;
  }

  return isValid;
}




  </script>

 


  </body>
  </html>
