<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Product - SHOEZO</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>


    <style>
        body {
            background-color: #f8f9fa;
            padding-top: 60px;
            overflow-x: hidden;
        }

        .sidebar-container {
            width: 250px;
            min-height: 100vh;
            background-color: hsl(210, 100%, 98%) !important;
            position: fixed;
            top: 60px;
            left: 0;
            z-index: 1020;
        }

        .main-content {
            margin-left: 250px;
            padding: 20px;
            width: calc(100% - 250px);
        }

        .card-form-variants {
            border: 1px solid #ddd;
            padding: 25px;
            border-radius: 8px;
            background-color: #fff;
        }

        .upload-box {
            border: 2px dashed #ddd;
            height: 120px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            text-align: center;
        }
    </style>
</head>

<body>

    <%- include('../partials/admin/navbar.ejs') %>

        <div class="d-flex w-100">
            <div class="sidebar-container">
                <%- include('../partials/admin/sidebar.ejs') %>
            </div>

            <div class="main-content">

                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h4 class="fw-bold">Add New Product</h4>
                    <a href="/admin/products" class="btn btn-secondary">Back</a>
                </div>

                <div class="card p-4 shadow-sm border-0">

                    <!-- ⭐ PRODUCT FORM ⭐ -->
                  <form method="post" action="/admin/add-product" enctype="multipart/form-data" onsubmit="return validateForm()">

  <!-- PRODUCT NAME -->
  <div class="row mb-3 align-items-center">
    <div class="col-md-2 text-md-end">
      <label class="form-label">Product Name :</label>
    </div>
    <div class="col-md-10">
      <input type="text"
             class="form-control form-control-sm"
             name="name">
      <small class="text-danger" id="nameError"></small>
    </div>
  </div>

  <!-- CATEGORY + BRAND -->
  <div class="row mb-3 align-items-center">

    <div class="col-md-2 text-md-end">
      <label class="form-label">Category :</label>
    </div>
    <div class="col-md-4">
      <select class="form-select form-select-sm" name="category" >
        <option value="">Select Category</option>
        <% categories.forEach(cat => { %>
          <option value="<%= cat._id %>"><%= cat.name %></option>
        <% }) %>
      </select>
      <small class="text-danger" id="categoryError"></small>
    </div>

    <div class="col-md-2 text-md-end">
      <label class="form-label">Brand :</label>
    </div>
    <div class="col-md-4">
      <select class="form-select form-select-sm" name="brand" >
        <option value="">Select Brand</option>
        <% brands.forEach(brand => { %>
          <option value="<%= brand._id %>"><%= brand.name %></option>
        <% }) %>
      </select>
      <small class="text-danger" id="brandError"></small>
    </div>

  </div>

  <!-- DESCRIPTION -->
  <div class="row mb-3 align-items-center">
    <div class="col-md-2 text-md-end">
      <label class="form-label">Description :</label>
    </div>
    <div class="col-md-10">
      <input type="text"
             class="form-control form-control-sm"
             name="description">
      <small class="text-danger" id="descriptionError"></small>
    </div>
  </div>

  <!-- PRICE -->
  <div class="row mb-3 align-items-center">
    <div class="col-md-2 text-md-end">
      <label class="form-label">Price :</label>
    </div>
    <div class="col-md-10">
      <input type="number"
             class="form-control form-control-sm"
             name="price">
      <small class="text-danger" id="priceError"></small>
    </div>
  </div>

  <!-- OFFER PRICE -->
  <div class="row mb-3 align-items-center">
    <div class="col-md-2 text-md-end">
      <label class="form-label">Offer Price :</label>
    </div>
    <div class="col-md-10">
      <input type="number"
             class="form-control form-control-sm"
             name="offerPrice">
      <small class="text-danger" id="offerpriceError"></small>
    </div>
  </div>

  <!-- VARIANTS -->
  <h5 class="fw-bold mb-3">Product Variants</h5>

  <div class="card-form-variants mb-4">
    <div class="row g-3">

      <div class="col-md-4">
        <label class="form-label">Size</label>
        <input type="text"
               class="form-control form-control-sm"
               name="size">
        <small class="text-danger" id="sizeError"></small>
      </div>

      <div class="col-md-4">
        <label class="form-label">Color</label>
        <input type="text"
               class="form-control form-control-sm"
               name="color">
        <small class="text-danger" id="colorError"></small>
      </div>

      <div class="col-md-4">
        <label class="form-label">Stock</label>
        <input type="number"
               class="form-control form-control-sm"
               name="stock">
        <small class="text-danger" id="stockError"></small>
      </div>

    </div>
  </div>

  <!-- IMAGE UPLOAD -->
  <label class="form-label">Upload Images</label>
  <div class="upload-box mb-3"
       onclick="document.getElementById('imagesInput').click()">
    <i class="fas fa-upload text-muted me-2"></i> Click to upload
  </div>

  <input type="file"
         id="imagesInput"
         name="images"
         multiple
         hidden>

  <div id="previewContainer" class="d-flex flex-wrap gap-2 mt-3"></div>
  <small class="text-danger" id="imageError"></small>

  <!-- SUBMIT -->
  <div class="text-center mt-4">
    <button type="submit" class="btn btn-dark px-5">
      ADD PRODUCT
    </button>
  </div>

</form>


        
<div id="cropModal" style="
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.65);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 9999;
">
  <div style="
      width: 90%;
      max-width: 850px;
      background: #fff;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
  ">
    
    <!-- Header (Bootstrap Style) -->
    <div style="
        padding: 12px 16px;
        border-bottom: 1px solid #ddd;
        display: flex;
        justify-content: space-between;
        align-items: center;
    ">
      <h5 class="modal-title" style="margin:0;">Crop Image</h5>
      <button id="cancelCrop" style="
          background:none;
          border:none;
          font-size:20px;
          cursor:pointer;
      ">&times;</button>
    </div>

    <!-- Body -->
    <div style="padding: 16px; max-height: 70vh; overflow:auto;">
      <img id="cropImage" style="width:100%; max-height:500px; display:block;">
    </div>

    <!-- Footer (Bootstrap Style) -->
    <div style="
        padding: 12px 16px;
        border-top: 1px solid #ddd;
        text-align: right;
    ">
      <button id="applyCrop" style="
          padding: 8px 16px;
          border-radius: 4px;
          border: none;
          background: #0d6efd;
          color: #fff;
          font-weight: 500;
          cursor: pointer;
      ">Crop & Save</button>
    </div>

  </div>
</div>










        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>


        <script>
            /* ------------------ GLOBAL VARIABLES ------------------ */
            let selectedFiles = [];
let cropper = null;
let cropIndex = 0;

const input = document.getElementById("imagesInput");
const preview = document.getElementById("previewContainer");
const cropModal = document.getElementById("cropModal");
const cropImage = document.getElementById("cropImage");

/* ------------------ OPEN / CLOSE CUSTOM MODAL ------------------ */
function openCropModal() {
    cropModal.style.display = "flex";
}

function closeCropModal() {
    cropModal.style.display = "none";
    if (cropper) cropper.destroy();
}

/* CLOSE MODAL ON CANCEL BUTTON */
document.getElementById("cancelCrop").onclick = closeCropModal;

/* ------------------ WHEN USER SELECTS FILE(S) ------------------ */
input.addEventListener("change", function (event) {
    const files = Array.from(event.target.files);
    if (files.length === 0) return;

    cropIndex = 0;
    startCropping(files);
});

/* ------------------ CROP LOGIC ------------------ */
function startCropping(files) {
    if (cropIndex >= files.length) {
        updatePreview();
        updateInputFiles();
        return;
    }

    const file = files[cropIndex];
    const reader = new FileReader();

    reader.onload = function (e) {
        cropImage.src = e.target.result;

        // Destroy old cropper
        if (cropper) cropper.destroy();

        // Create new cropper
        cropper = new Cropper(cropImage, {
            aspectRatio: 1,
            viewMode: 1,
            autoCropArea: 1
        });

        openCropModal();
    };

    reader.readAsDataURL(file);
}

/* ------------------ APPLY CROP ------------------ */
document.getElementById("applyCrop").onclick = function () {
    const canvas = cropper.getCroppedCanvas({
        width: 500,
        height: 500,
    });

    canvas.toBlob(blob => {
        const croppedFile = new File([blob], `cropped-${Date.now()}.jpg`, {
            type: "image/jpeg"
        });

        selectedFiles.push(croppedFile);

        closeCropModal();
        cropIndex++;

        startCropping(Array.from(input.files));


        updateInputFiles();
    });
};

/* ------------------ SHOW THUMBNAILS ------------------ */
   function updatePreview() {
    preview.innerHTML = "";

    selectedFiles.forEach((file, index) => {
        const wrapper = document.createElement("div");
        wrapper.style.position = "relative";
        wrapper.style.display = "inline-block";

        const img = document.createElement("img");
        img.src = URL.createObjectURL(file);
        img.style.width = "90px";
        img.style.height = "90px";
        img.style.objectFit = "cover";
        img.style.margin = "5px";
        img.style.borderRadius = "6px";
        img.style.border = "1px solid #ccc";

        // ❌ REMOVE BUTTON
        const removeBtn = document.createElement("span");
        removeBtn.innerHTML = "&times;";
        removeBtn.style.position = "absolute";
        removeBtn.style.top = "0px";
        removeBtn.style.right = "4px";
        removeBtn.style.fontSize = "22px";
        removeBtn.style.color = "red";
        removeBtn.style.cursor = "pointer";
        removeBtn.style.fontWeight = "bold";

        removeBtn.onclick = function () {
            selectedFiles.splice(index, 1);   // remove from array
            updatePreview();                  // refresh thumbnails
            updateInputFiles();               // refresh input.files
        };

        wrapper.appendChild(img);
        wrapper.appendChild(removeBtn);
        preview.appendChild(wrapper);
    });
}




  //  validation 


  function validateForm() {

  // clear old errors
  document.querySelectorAll("small.text-danger")
    .forEach(el => el.innerText = "");

  let isValid = true;

  const name = document.querySelector("input[name='name']").value.trim();
  const category = document.querySelector("select[name='category']").value;
  const brand = document.querySelector("select[name='brand']").value;
  const description = document.querySelector("input[name='description']").value.trim();
  const price = document.querySelector("input[name='price']").value;
  const offerPrice = document.querySelector("input[name='offerPrice']").value;
  const size = document.querySelector("input[name='size']").value.trim();
  const color = document.querySelector("input[name='color']").value.trim();
  const stock = document.querySelector("input[name='stock']").value;

  // PRODUCT NAME
  if (!name) {
    document.getElementById("nameError").innerText = "Product name is required";
    isValid = false;
  }

  // CATEGORY
  if (!category) {
    document.getElementById("categoryError").innerText = "Category is required";
    isValid = false;
  }

  // BRAND
  if (!brand) {
    document.getElementById("brandError").innerText = "Brand is required";
    isValid = false;
  }

  // DESCRIPTION
  if (!description) {
    document.getElementById("descriptionError").innerText = "Description is required";
    isValid = false;
  }

  // PRICE
  if (!price || price <= 0) {
    document.getElementById("priceError").innerText = "Enter a valid price";
    isValid = false;
  }

  // OFFER PRICE
  if (!offerPrice || offerPrice <= 0) {
    document.getElementById("offerpriceError").innerText = "Enter a valid offer price";
    isValid = false;
  } else if (Number(offerPrice) >= Number(price)) {
    document.getElementById("offerpriceError").innerText =
      "Offer price must be less than price";
    isValid = false;
  }

  // SIZE
  if (!size) {
    document.getElementById("sizeError").innerText = "Size is required";
    isValid = false;
  }

  // COLOR
  if (!color) {
    document.getElementById("colorError").innerText = "Color is required";
    isValid = false;
  }

  // STOCK
  if (!stock || stock < 0) {
    document.getElementById("stockError").innerText = "Stock must be 0 or more";
    isValid = false;
  }

  // IMAGES (MIN 1, MAX 10)
  if (selectedFiles.length < 1) {
    document.getElementById("imageError").innerText =
      "At least 1 product image is required";
    isValid = false;
  } else if (selectedFiles.length > 10) {
    document.getElementById("imageError").innerText =
      "Maximum 10 images allowed";
    isValid = false;
  }

  return isValid;
}



function updateInputFiles() {
  const dataTransfer = new DataTransfer();

  selectedFiles.forEach(file => {
    dataTransfer.items.add(file);
  });

  input.files = dataTransfer.files;
}




//  sweat  alert validation

const params = new URLSearchParams(window.location.search);
  const status = params.get("status");

  if (status === "success") {
    Swal.fire({
      icon: "success",
      title: "Product Added Successfully",
      text: "Your product has been added.",
      showConfirmButton: false,
      timer: 2000
    });
  }

  if (status === "error") {
    Swal.fire({
      icon: "error",
      title: "Failed to Add Product",
      text: "Something went wrong. Please try again."
    });
  }

  // clean URL
  if (status) {
    window.history.replaceState({}, document.title, window.location.pathname);
  }




        </script>



</body>

</html>