<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SHOEZO - OTP Verification</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- SweetAlert + jQuery -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Geist:wght@400;500;600;700&display=swap');

    :root {
      --max-form-width: 420px;
    }

    /* a little wider so it matches screenshot */

    html,
    body {
      height: 100%;
      margin: 0;
    }

    body {
      font-family: 'Geist', sans-serif;
      background: #ffffff;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* Page split: left image + right centered form */
    .page {
      display: flex;
      min-height: 100vh;
      width: 100%;
    }

    .left-side,
    .right-side {
      flex: 1 1 50%;
      min-width: 0;
    }

    /* Left image - use the uploaded file */
    .left-side {
      display: none;
    }

    @media (min-width: 768px) {
      .left-side {
        display: block;
      }
    }

    .left-image {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    /* Right side: perfectly centered vertically, but nudged slightly left so form sits nearer center-right */
    .right-side {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px 48px;
      /* horizontal padding so form sits a bit inward like screenshot */
      overflow: auto;
    }

    .form-wrap {
      max-width: var(--max-form-width);
      width: 100%;
      margin: 0 auto;
      text-align: center;
      transition: transform 220ms ease;
      transform: none;
      /* nudge the whole form slightly to the left within the right half so it visually sits like your screenshot */
      margin-left: 40px;
    }

    /* On wider screens, reduce the left nudging so it matches screenshot proportions */
    @media (min-width:1200px) {
      .form-wrap {
        margin-left: 60px;
      }
    }

    .italic-brand {
      font-style: italic;
      font-weight: 700;
    }

    h1 {
      font-size: 48px;
      line-height: 1;
      margin-bottom: .6rem;
    }

    h2 {
      font-size: 26px;
      margin-bottom: .4rem;
    }

    .otp-input {
      width: 60px;
      height: 60px;
      font-size: 24px;
      font-weight: 600;
      text-align: center;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      background: #f3f4f6;
      transition: 0.18s;
    }

    .otp-input:focus {
      border-color: #000;
      background: #fff;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      outline: none;
    }

    .otp-input::-webkit-outer-spin-button,
    .otp-input::-webkit-inner-spin-button {
      -webkit-appearance: none;
      appearance: none;
      margin: 0;
    }

    .otp-input[type=number] {
      -moz-appearance: textfield;
    }

    @keyframes pulse-timer {

      0%,
      100% {
        opacity: 1
      }

      50% {
        opacity: 0.7
      }
    }

    .timer-pulse {
      animation: pulse-timer 1s infinite;
    }

    .confirm-btn {
      width: 160px;
      border-radius: 12px;
      padding: 8px 0;
    }

    /* Shift up when keyboard opens or input focused (mobile & desktop) */
    .form-wrap.shift-up {
      transform: translateY(-28%);
    }

    @media (max-width: 767.98px) {
      .form-wrap.shift-up {
        transform: translateY(-18%);
      }

      .otp-input {
        width: 54px;
        height: 54px;
        font-size: 22px;
      }
    }

    /* Mobile adjustments */
    @media (max-width: 767.98px) {
      .right-side {
        padding-left: 16px;
        padding-right: 16px;
      }

      .form-wrap {
        margin-left: 0;
      }
    }
  </style>
</head>

<body>

  <div class="page">
    <!-- LEFT IMAGE (hidden on small screens) -->
    <div class="left-side d-none d-md-block">
      <!-- use the uploaded image path -->
      <img src="/images/otpp.jpeg" alt="OTP Shoe" class="left-image" />
    </div>

    <!-- RIGHT FORM (centered vertically; positioned to match screenshot) -->
    <div class="right-side">
      <div class="form-wrap">

        <h1 class="italic-brand">SHOEZO</h1>
        <h2 class="fw-bold">Email OTP Verification</h2>

        <% let maskedEmail="your email" ; if (email && typeof email==="string" && email.includes("@")) { const
          parts=email.split("@"); const name=parts[0]; const domain=parts[1]; const maskedName=name.length> 2
          ? name.slice(0, 2) + "*".repeat(name.length - 2)
          : name[0] + "*";

          maskedEmail = maskedName + "@" + domain;
          }
          %>

          <p class="text-muted mb-3" style="font-size:14px;">
            Enter OTP sent to <%= maskedEmail %>
          </p>


          <form id="otpForm">
            <input type="hidden" name="otp" id="finalOtp">

            <div class="d-flex justify-content-between mb-4" style="gap:16px; max-width:340px; margin:0 auto;">
              <input type="text" maxlength="1" class="otp-input">
              <input type="text" maxlength="1" class="otp-input">
              <input type="text" maxlength="1" class="otp-input">
              <input type="text" maxlength="1" class="otp-input">
            </div>

            <button type="submit" class="btn btn-dark confirm-btn fw-semibold">
              Confirm
            </button>
          </form>



          <div class="text-center mt-3">
            <button class="btn btn-link text-muted" onclick="handleResendOTP()">Resend OTP</button>
          </div>

      </div>
    </div>
  </div>


  <script>
    const inputs = document.querySelectorAll(".otp-input");
    const finalOtpInput = document.getElementById("finalOtp");

    function updateFinalOtp() {
      let otp = "";
      inputs.forEach(i => otp += i.value);
      finalOtpInput.value = otp;
    }

    inputs.forEach((input, index) => {
      // Auto-next on input
      input.addEventListener("input", (e) => {
        const val = e.target.value;
        if (!/^\d*$/.test(val)) e.target.value = "";

        if (e.target.value.length === 1 && inputs[index + 1]) {
          inputs[index + 1].focus();
        }
        updateFinalOtp();
      });

      // Backspace support
      input.addEventListener("keydown", (e) => {
        if (e.key === "Backspace" && !e.target.value && index > 0) {
          inputs[index - 1].focus();
        }
      });

      // Paste support
      input.addEventListener("paste", (e) => {
        e.preventDefault();
        const pasteData = (e.clipboardData || window.clipboardData).getData("text");
        const digits = pasteData.replace(/\D/g, "").slice(0, 4);

        digits.split("").forEach((digit, i) => {
          if (inputs[i]) inputs[i].value = digit;
        });

        updateFinalOtp();

        // Focus the last filled input or the first empty one
        const nextToFocus = inputs[digits.length] || inputs[inputs.length - 1];
        if (nextToFocus) nextToFocus.focus();
      });
    });

    const otpForm = document.getElementById("otpForm");
    otpForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const otp = finalOtpInput.value.trim();

      if (!otp || otp.length !== 4) {
        Swal.fire("Error", "Please enter all 4 digits", "error");
        return;
      }

      const res = await fetch("/verify-email-otp", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ otp })
      });

      const data = await res.json();
      if (data.success) {
        Swal.fire({
          icon: "success",
          title: "Email Verified",
          text: "Your email has been updated successfully",
          confirmButtonText: "OK"
        }).then(() => {
          window.location.href = "/user/profile";
        });
      } else {
        Swal.fire("Error", data.message || "Invalid OTP", "error");
      }
    });

    async function handleResendOTP() {
      const res = await fetch("/user/resend-email-otp", {
        method: "POST",
        headers: { "Content-Type": "application/json" }
      });

      const data = await res.json();
      if (data.success) {
        Swal.fire({
          icon: "success",
          title: "OTP Sent",
          text: "A new OTP has been sent to your email"
        });

        inputs.forEach(i => i.value = "");
        finalOtpInput.value = "";
        inputs[0].focus();
      } else {
        Swal.fire("Error", data.message, "error");
      }
    }
  </script>